<!DOCTYPE html>

<html>
<head>
  <title>DataSet.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="DataSet.html">
                  DataSet.js
                </a>
              
                
                <a class="source" href="OofA.html">
                  OofA.js
                </a>
              
                
                <a class="source" href="app.html">
                  app.js
                </a>
              
                
                <a class="source" href="util.html">
                  util.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>DataSet.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> u <span class="hljs-keyword">from</span> <span class="hljs-string">'lib/util.js'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A <strong>DataSet</strong> is an object with width/height and an array
whose length = width * height</p>
<p>The data array can be a TypedArray or a javascript Array
Note that it is very much like an ImageData object!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSet</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><strong>Static methods:</strong> called via DataSet.foo(), similar to Math.foo().
Generally useful utilities for use with TypedArrays &amp; JS Arrays</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Convert Array or TypedArray to given Type (Array or TypedArray).
If array is already of correct type, return it unmodified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">static</span> convertArray(array, Type) {
    <span class="hljs-keyword">const</span> Type0 = array.constructor
    <span class="hljs-keyword">if</span> (Type0 === Type) <span class="hljs-keyword">return</span> array <span class="hljs-comment">// return array if already same Type</span>
    <span class="hljs-keyword">if</span> (Type !== <span class="hljs-built_in">Array</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Type(array) <span class="hljs-comment">// TypedArray: universal ctor</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.prototype.slice.call(array) <span class="hljs-comment">// Convert TypedArray to Array</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Return a new copy of array, with correct type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">static</span> copyArray(array) {
    <span class="hljs-keyword">if</span> (array.constructor === <span class="hljs-built_in">Array</span>) <span class="hljs-keyword">return</span> array.slice(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> array.constructor(array)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Return a new array that is the concatination two arrays.
The resulting type is that of the first array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">static</span> concatArrays(array1, array2) {
    <span class="hljs-keyword">const</span> Type = array1.constructor
    <span class="hljs-keyword">if</span> (Type === <span class="hljs-built_in">Array</span>)
      <span class="hljs-keyword">return</span> array1.concat(DataSet.convertArray(array2, <span class="hljs-built_in">Array</span>))
    <span class="hljs-keyword">const</span> array = <span class="hljs-keyword">new</span> Type(array1.length + array2.length)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Note typedArray.set() allows any Array or TypedArray array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    array.set(array1); array.set(array2, array1.length)
    <span class="hljs-keyword">return</span> array
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Return array’s type (Array or TypedArray variant)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">static</span> type(array) { <span class="hljs-keyword">return</span> array.constructor }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The <strong>DataSet Class</strong> constructor and methods</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>constructor: Stores the three DataSet components.
Checks data is right size, throws an error if not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">constructor</span>(width, height, data) {
    <span class="hljs-keyword">if</span> (data.length !== width * height)
      <span class="hljs-keyword">throw</span> <span class="hljs-string">`new DataSet length error: <span class="hljs-subst">${width}</span> * <span class="hljs-subst">${height}</span> != <span class="hljs-subst">${data.length}</span>`</span>
    <span class="hljs-keyword">else</span>
      [<span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height, <span class="hljs-keyword">this</span>.data] = [width, height, data]
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Checks x,y are within DataSet. Throw error if not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  checkXY(x, y) {
    <span class="hljs-keyword">if</span> (!(u.between(x, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.width - <span class="hljs-number">1</span>) &amp;&amp; u.between(y, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.height - <span class="hljs-number">1</span>)))
      <span class="hljs-keyword">throw</span> <span class="hljs-string">`DataSet.checkXY: x,y out of range: <span class="hljs-subst">${x}</span>, <span class="hljs-subst">${y}</span>`</span>
  }

  type() { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.data.constructor }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Given x,y in data space, return index into data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toIndex(x, y) { <span class="hljs-keyword">return</span> x + y * <span class="hljs-keyword">this</span>.width }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Given index into data, return dataset x,y</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toXY(i) { <span class="hljs-keyword">return</span> [i % <span class="hljs-keyword">this</span>.width, <span class="hljs-built_in">Math</span>.floor(i / <span class="hljs-keyword">this</span>.width)] }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Get dataset value at x,y, checking that x,y valid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getXY(x, y) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.data[<span class="hljs-keyword">this</span>.toIndex(x, y)] }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Set the data value at x,y to num</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setXY(x, y, num) { <span class="hljs-keyword">this</span>.data[<span class="hljs-keyword">this</span>.toIndex(x, y)] = num }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Wrapper for sampling, defaults to “nearest”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sample(x, y, useNearest = <span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">return</span> useNearest ? <span class="hljs-keyword">this</span>.nearest(x, y) : <span class="hljs-keyword">this</span>.bilinear(x, y)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Nearest neighbor sampling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  nearest(x, y) {
    <span class="hljs-keyword">this</span>.checkXY(<span class="hljs-built_in">Math</span>.round(x), <span class="hljs-built_in">Math</span>.round(y))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getXY(<span class="hljs-built_in">Math</span>.round(x), <span class="hljs-built_in">Math</span>.round(y))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Billinear sampling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bilinear(x, y) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Billinear sampling works by making two linear interpolations (lerps)
in the x direction, and a third in the y direction, between the
two x results. See wikipedia:
<a href="http://en.wikipedia.org/wiki/Bilinear_interpolation">bilinear sampling</a>
The diagram shows the three lerps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.checkXY(x, y)
    <span class="hljs-keyword">const</span> [x0, y0] = [<span class="hljs-built_in">Math</span>.floor(x), <span class="hljs-built_in">Math</span>.floor(y)]
    <span class="hljs-keyword">const</span> i = <span class="hljs-keyword">this</span>.toIndex(x0, y0)
    <span class="hljs-keyword">const</span> w = <span class="hljs-keyword">this</span>.width
    <span class="hljs-keyword">const</span> [dx, dy] = [(x - x0), (y - y0)] <span class="hljs-comment">// dx, dy = 0 if x, y on boundary</span>
    <span class="hljs-keyword">const</span> [dx1, dy1] = [<span class="hljs-number">1</span> - dx, <span class="hljs-number">1</span> - dy] <span class="hljs-comment">// dx1, dy1 = 1 if x, y on boundary</span>
    <span class="hljs-keyword">const</span> f00 = <span class="hljs-keyword">this</span>.data[i]</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Edge case: fij is 0 if beyond data array; undefined -&gt; 0.
This cancels the given component’s factor in the result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> f10 = <span class="hljs-keyword">this</span>.data[i + <span class="hljs-number">1</span>] || <span class="hljs-number">0</span> <span class="hljs-comment">// 0 at bottom right corner</span>
    <span class="hljs-keyword">const</span> f01 = <span class="hljs-keyword">this</span>.data[i + w] || <span class="hljs-number">0</span> <span class="hljs-comment">// 0 at all bottom row</span>
    <span class="hljs-keyword">const</span> f11 = <span class="hljs-keyword">this</span>.data[i + <span class="hljs-number">1</span> + w] || <span class="hljs-number">0</span> <span class="hljs-comment">// 0 at end of next to bottom row</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>This is a bit involved but:</p>
<pre><code>If dx = <span class="hljs-number">0</span>; dx1 = <span class="hljs-number">1</span>, dy != <span class="hljs-number">0</span>
-&gt; vertical linear interpolation
fxy = f00(<span class="hljs-number">1</span>-dy) + f01(dy) i.e. y-lerp

If dx != <span class="hljs-number">0</span>; dy = <span class="hljs-number">0</span>, dx !=<span class="hljs-number">0</span>
-&gt; horizontal linear interpolation
fxy = f00(<span class="hljs-number">1</span>-dx) + f10(dx) i.e. x-lerp
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> (f00 * dx1 * dy1) + (f10 * dx * dy1) +
           (f01 * dx1 * dy) + (f11 * dx * dy)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Return a copy of this, with new data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  copy() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSet(<span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height, DataSet.copyArray(<span class="hljs-keyword">this</span>.data))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Return new (empty) dataset of this type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  newEmpty(width, height) {
    <span class="hljs-keyword">const</span> Type = <span class="hljs-keyword">this</span>.type()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSet(width, height, <span class="hljs-keyword">new</span> Type(width * height))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Create new dataset of size width/height by resampling each point.
If same size, return a copy of this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resample(width, height, useNearest = <span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">if</span> (width === <span class="hljs-keyword">this</span>.width &amp;&amp; height === <span class="hljs-keyword">this</span>.height) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.copy()
    <span class="hljs-keyword">const</span> ds = <span class="hljs-keyword">this</span>.newEmpty(width, height)
    <span class="hljs-keyword">const</span> xScale = (<span class="hljs-keyword">this</span>.width - <span class="hljs-number">1</span>) / (width - <span class="hljs-number">1</span>)
    <span class="hljs-keyword">const</span> yScale = (<span class="hljs-keyword">this</span>.height - <span class="hljs-number">1</span>) / (height - <span class="hljs-number">1</span>)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; height; y++)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; width; x++)
        ds.setXY(x, y, <span class="hljs-keyword">this</span>.sample(x * xScale, y * yScale, useNearest))
    <span class="hljs-keyword">return</span> ds
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Return a rectangular subset of the dataset.
Returned dataset is of same array type as this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  subset(x, y, width, height) {
    <span class="hljs-keyword">if</span> ((x + width) &gt; <span class="hljs-keyword">this</span>.width || (y + height) &gt; <span class="hljs-keyword">this</span>.height)
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'DataSet.subSet: params out of range'</span>
    <span class="hljs-keyword">const</span> ds = <span class="hljs-keyword">this</span>.newEmpty(width, height)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; width; i++)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; height; j++)
        ds.setXY(i, j, <span class="hljs-keyword">this</span>.getXY(i + x, j + y))
    <span class="hljs-keyword">return</span> ds
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Return filtered dataset by applying f to each dataset element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  filter(f) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSet(<span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height, <span class="hljs-keyword">this</span>.data.map(f))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Return the column of data at position x in the dataset as Array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  col(x) {
    <span class="hljs-keyword">const</span> [colData, data, w, h] = [[], <span class="hljs-keyword">this</span>.data, <span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height]
    <span class="hljs-keyword">if</span> (x &gt;= w)
      <span class="hljs-keyword">throw</span> <span class="hljs-string">`col: x out of range width: <span class="hljs-subst">${w}</span> x: <span class="hljs-subst">${x}</span>`</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; h; i++)
      colData.push(data[x + i * w])
    <span class="hljs-keyword">return</span> colData
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Return the row of data at position y in the dataset as Array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  row(y) {
    <span class="hljs-keyword">const</span> [w, h] = [<span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height]
    <span class="hljs-keyword">if</span> (y &gt;= h)
      <span class="hljs-keyword">throw</span> <span class="hljs-string">`row: y out of range height: <span class="hljs-subst">${h}</span> x: <span class="hljs-subst">${y}</span>`</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.data.slice(y * w, (y + <span class="hljs-number">1</span>) * w)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Return array converted to my data’s Type.
If array is my Type, return w/o conversion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toThisType(array) {
    <span class="hljs-keyword">const</span> type = <span class="hljs-keyword">this</span>.type()
    <span class="hljs-keyword">if</span> (array.constructor === type) <span class="hljs-keyword">return</span> array
    <span class="hljs-keyword">return</span> DataSet.convertArray(array, type)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Convert this dataset’s data to new type. Precision may be lost.
Does nothing if current data is already of this Type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  convertType(type) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type() === type) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">this</span>.data = DataSet.convertArray(<span class="hljs-keyword">this</span>.data, type)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Concatinate a dataset of equal height to my right to my east.
New DataSet is of same type as this.</p>
<p>Note: concatWest is dataset.concatEast(this)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  concatEast(dataset) {
    <span class="hljs-keyword">const</span> [w, h] = [<span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height]
    <span class="hljs-keyword">if</span> (h !== dataset.height)
      <span class="hljs-keyword">throw</span> <span class="hljs-string">`concatEast: heights not equal <span class="hljs-subst">${h}</span>, <span class="hljs-subst">${dataset.height}</span>`</span>
    <span class="hljs-keyword">let</span> newData = []
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; h; i++)
      newData = newData.concat(<span class="hljs-keyword">this</span>.row(i).concat(dataset.row(i)))
    newData = <span class="hljs-keyword">this</span>.toThisType(newData)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSet(w + dataset.width, h, newData)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Concatinate a dataset of equal width to my south, returning new DataSet.
New DataSet is of same type as this.</p>
<p>Note: concatNorth is dataset.concatSouth(this)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  concatSouth(dataset) {
    <span class="hljs-keyword">const</span> [w, h, data] = [<span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height, <span class="hljs-keyword">this</span>.data]
    <span class="hljs-keyword">if</span> (w !== dataset.width)
      <span class="hljs-keyword">throw</span> <span class="hljs-string">`concatSouth: widths not equal <span class="hljs-subst">${w}</span>, <span class="hljs-subst">${dataset.width}</span>`</span>
    <span class="hljs-keyword">const</span> data1 = DataSet.concat(data, dataset.data)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSet(w, h + dataset.height, data1)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>return dataset x,y given x,y in a euclidean space defined by tlx, tly, w, h
x,y is in topleft-bottomright box: [tlx,tly,tlx+w,tly-h], y positive up
Ex: NetLogo’s coords: x, y, minXcor, maxYcor, numX, numY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transformCoords(x, y, tlx, tly, w, h) {
    <span class="hljs-keyword">const</span> xs = (x - tlx) * (<span class="hljs-keyword">this</span>.width - <span class="hljs-number">1</span>) / w
    <span class="hljs-keyword">const</span> ys = (tly - y) * (<span class="hljs-keyword">this</span>.height - <span class="hljs-number">1</span>) / h
    <span class="hljs-keyword">return</span> [xs, ys]
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>get a sample using a transformed euclidean coord system; see above</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  coordSample(x, y, tlx, tly, w, h, useNearest = <span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> [xs, ys] = <span class="hljs-keyword">this</span>.transformCoords(x, y, tlx, tly, w, h)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sample(xs, ys, useNearest)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Return Array 3x3 neighbor values of the given x,y of the dataset.
Off-edge neighbors revert to nearest edge value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  neighborhood(x, y, array = []) {
    array.length = <span class="hljs-number">0</span>  <span class="hljs-comment">// in case user supplied an array</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> dy = <span class="hljs-number">-1</span>; dy &lt;= +<span class="hljs-number">1</span>; dy++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> dx = <span class="hljs-number">-1</span>; dx &lt;= +<span class="hljs-number">1</span>; dx++) {
        <span class="hljs-keyword">const</span> x0 = u.clamp(x + dx, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.width - <span class="hljs-number">1</span>)
        <span class="hljs-keyword">const</span> y0 = u.clamp(y + dy, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.height - <span class="hljs-number">1</span>)
        array.push(<span class="hljs-keyword">this</span>.data[<span class="hljs-keyword">this</span>.toIndex(x0, y0)])
      }
    }
    <span class="hljs-keyword">return</span> array
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Return a new Array dataset convolved with the given kernel 3x3 matrix.
See <a href="https://goo.gl/gCfXmU">Convolution article</a></p>
<p>If cropped, do not convolve the edges, returning a smaller dataset.
If not, convolve the edges by extending edge values, returning
dataset of same size.</p>
<p>Use ds.convertType to convert to typed array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  convolve(kernel, factor = <span class="hljs-number">1</span>, crop = <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">const</span> array = [] <span class="hljs-comment">// new convolved data</span>
    <span class="hljs-keyword">const</span> n = [] <span class="hljs-comment">// the current neighborhood</span>
    <span class="hljs-keyword">const</span> [x0, y0, h, w] = crop ? <span class="hljs-comment">// the coords being convolved</span>
      [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.height - <span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.width - <span class="hljs-number">1</span>] :
      [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.height, <span class="hljs-keyword">this</span>.width]
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = y0; y &lt; h; y++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = x0; x &lt; w; x++) {
        <span class="hljs-keyword">this</span>.neighborhood(x, y, n)
        array.push(u.aSum(u.aPairMul(kernel, n)) * factor)
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSet(w - x0, h - y0, array)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>A few common convolutions.  dzdx/y are also called horiz/vert Sobel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dzdx(n = <span class="hljs-number">2</span>, factor = <span class="hljs-number">1</span> / <span class="hljs-number">8</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.convolve([<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, -n, <span class="hljs-number">0</span>, n, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>], factor)
  }
  dzdy(n = <span class="hljs-number">2</span>, factor = <span class="hljs-number">1</span> / <span class="hljs-number">8</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.convolve([<span class="hljs-number">1</span>, n, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, -n, <span class="hljs-number">-1</span>], factor)
  }
  laplace8() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.convolve([<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>])
  }
  laplace4() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.convolve([<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>])
  }
  blur(factor = <span class="hljs-number">0.0625</span>) { <span class="hljs-comment">// 1/16 = 0.0625</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.convolve([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>], factor)
  }
  edge() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.convolve([<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">-7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Create two new Array convolved datasets, slope and aspect, common in
the use of an elevation data set. See Esri tutorials for
<a href="http://goo.gl/ZcOl08">slope</a> and <a href="http://goo.gl/KoI4y5">aspect</a></p>
<p>It also returns the two derivitive DataSets, dzdx, dzdy for
those wanting to use the results of the two convolutions.</p>
<p>Use this.convertType to convert to typed array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  slopeAndAspect(cellSize = <span class="hljs-number">1</span>, noNaNs = <span class="hljs-literal">true</span>, posAngle = <span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> dzdx = <span class="hljs-keyword">this</span>.dzdx() <span class="hljs-comment">// sub left z from right</span>
    <span class="hljs-keyword">const</span> dzdy = <span class="hljs-keyword">this</span>.dzdy() <span class="hljs-comment">// sub bottom z from top</span>
    <span class="hljs-keyword">let</span> [aspect, slope] = [[], []]
    <span class="hljs-keyword">const</span> [h, w] = [dzdx.height, dzdx.width]
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; h; y++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; w; x++) {
        <span class="hljs-keyword">let</span> [gx, gy] = [dzdx.getXY(x, y), dzdy.getXY(x, y)]
        slope.push(<span class="hljs-built_in">Math</span>.atan(u.distance(gx, gy)) / cellSize) <span class="hljs-comment">// radians</span>
        <span class="hljs-keyword">while</span> (noNaNs &amp;&amp; gx === gy) {
          gx += u.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">0.0001</span>); gy += u.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">0.0001</span>)
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>radians in [-PI,PI], downhill</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> rad = (gx === gy &amp;&amp; gy === <span class="hljs-number">0</span>) ? <span class="hljs-literal">NaN</span> : <span class="hljs-built_in">Math</span>.atan2(-gy, -gx)</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>positive radians in [0,2PI] if desired</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (posAngle &amp;&amp; rad &lt; <span class="hljs-number">0</span>) rad += <span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.PI
        aspect.push(rad)
      }
    }
    slope = <span class="hljs-keyword">new</span> DataSet(w, h, slope)
    aspect = <span class="hljs-keyword">new</span> DataSet(w, h, aspect)
    <span class="hljs-keyword">return</span> { slope, aspect, dzdx, dzdy }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Convert dataset to an image context object.</p>
<p>This can be used to “visualize” the data by normalizing
which will scale the data to use the entire RGB space.
It can also be used to create tiles or image-as-data if
the defaults are used.</p>
<p>Due to alpha-premultiply, the best we can do as data is 24 bit ints.
You can simulate floats/fixed by multiplying the dataset
the dividing on conversion back.</p>
<p>Our preferred transport is in the works, likely in the
tile datasets via blobs or arraybuffers. Sigh.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toContext(normalizeImage = <span class="hljs-literal">false</span>, gray = <span class="hljs-literal">false</span>, alpha = <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">const</span> [w, h, data] = [<span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height, <span class="hljs-keyword">this</span>.data]
    <span class="hljs-keyword">let</span> idata
    <span class="hljs-keyword">if</span> (normalizeImage) {
      idata = gray ?
        u.normalize8(data) : u.normalizeInt(data, <span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">24</span>) - <span class="hljs-number">1</span>)
    } <span class="hljs-keyword">else</span> {
      idata = data.map(a =&gt; <span class="hljs-built_in">Math</span>.round(a))
    }
    <span class="hljs-keyword">const</span> ctx = u.createCtx(w, h)
    <span class="hljs-keyword">const</span> id = ctx.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h)
    <span class="hljs-keyword">const</span> ta = id.data <span class="hljs-comment">// ta short for typed array</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; idata.length; i++) {
      <span class="hljs-keyword">const</span> [num, j] = [idata[i], <span class="hljs-number">4</span> * i] <span class="hljs-comment">// j = byte index into ta</span>
      <span class="hljs-keyword">if</span> (gray) {
        ta[j] = ta[j + <span class="hljs-number">1</span>] = ta[j + <span class="hljs-number">2</span>] = <span class="hljs-built_in">Math</span>.floor(num); ta[j + <span class="hljs-number">3</span>] = alpha
      } <span class="hljs-keyword">else</span> {
        ta[j] = (num &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>
        ta[j + <span class="hljs-number">1</span>] = (num &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>
        ta[j + <span class="hljs-number">2</span>] = num &amp; <span class="hljs-number">0xff</span>
        ta[j + <span class="hljs-number">3</span>] = <span class="hljs-number">255</span>
      }
    }
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'toContext image data'</span>, id.data)
    ctx.putImageData(id, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'toContext new image data'</span>, u.ctxToImageData(ctx).data)
    <span class="hljs-keyword">return</span> ctx
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Convert dataset to a canvas, which can be used as an image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toCanvas(gray, normalizeImage = <span class="hljs-literal">true</span>, alpha = <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toContext(gray, normalizeImage, alpha).canvas
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Convert dataset to a base64 string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toDataUrl(gray, normalizeImage = <span class="hljs-literal">true</span>, alpha = <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">return</span> u.ctxToDataUrl(<span class="hljs-keyword">this</span>.toContext(gray, normalizeImage, alpha))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Import an image as a dataset via it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> DataSet</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
